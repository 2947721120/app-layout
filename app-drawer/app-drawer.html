<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../app-scroll-behaviors/app-document-scroll-behavior.html">
<link rel="import" href="../app-scrim/app-scrim.html">

<!--
app-drawer is a navigation drawer that can slide in from the left or right.

Example:

Add a drawer on the left side of the screen (default):

```html
<app-drawer opened></app-drawer>
```

Add a drawer on the right side of the screen:

```html
<app-drawer position="right" opened></app-drawer>
```

### Styling

Custom property          | Description
-------------------------|-------------------------
`--app-drawer-styles`    | Mixin for drawer styles
`--app-scrim-styles`     | Mixin for scrim styles

@demo app-drawer/demo.html
-->

<dom-module id="app-drawer">

  <style>

    #drawerContent {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      width: 256px;
      background-color: #FFF;

      -webkit-transform: translate(-100%, 0);
      transform: translate(-100%, 0);

      -webkit-transition-property: -webkit-transform;
      transition-property: transform;

      -webkit-transition-duration: var(--app-drawer-duration, 0.2s);
      transition-duration: var(--app-drawer-duration, 0.2s);

      -webkit-transition-timing-function: var(--app-drawer-timing-function, ease);
      transition-timing-function: var(--app-drawer-timing-function, ease);

      @apply(--app-drawer-styles);
    }

    :host[position=right] #drawerContent {
      left: auto;
      right: 0;

      -webkit-transform: translate(100%, 0);
      transform: translate(100%, 0);
    }

    :host[swipe-open] #drawerContent::after {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 100%;
      width: 15px;
      content: '';
    }

    :host[swipe-open][position=right] #drawerContent::after {
      left: auto;
      right: 100%;
    }

    :host[opened] #drawerContent {
      -webkit-transform: translate(0, 0);
      transform:  translate(0, 0);
    }

    #scrim {
      @apply(--app-scrim-styles);
    }

  </style>

  <template>

    <app-scrim id="scrim" visible$="[[_isScrimVisible(opened, persistent)]]"></app-scrim>

    <div id="drawerContent">
      <content></content>
    </div>

  </template>

  <script>

    Polymer({

      is: 'app-drawer',

      behaviors: [
        Polymer.AppDocumentScrollBehavior
      ],

      properties: {

        /**
         * The opened state of the drawer.
         */
        opened: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true,
          observer: '_openedChanged'
        },

        /**
         * The drawer does not close when tapped or swiped.
         */
        persistent: {
          type: Boolean,
          value: false,
          observer: '_persistentChanged'
        },

        /**
         * The position of the drawer on the screen ('left' or 'right').
         */
        position: {
          type: String,
          value: 'left',
          reflectToAttribute: true
        },

        /**
         * Create an area at the edge of the screen to swipe open the drawer.
         */
        swipeOpen: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        _lastTrackDirection: Number,

        _translateOffset: Number

      },

      listeners: {
        tap: '_tapHandler',
        track: '_trackHandler'
      },

      /**
       * Opens the drawer.
       */
      open: function() {
        this.opened = true;
      },

      /**
       * Closes the drawer.
       */
      close: function() {
        this.opened = false;
      },

      /**
       * Toggles the drawer open and close.
       */
      toggle: function() {
        this.opened = !this.opened;
      },

      /**
       * Gets the width of the drawer.
       *
       * @return {number} The width of the drawer in pixels.
       */
      getDrawerWidth: function() {
        return this.$.drawerContent.offsetWidth;
      },

      _tapHandler: function() {
        if (!this.persistent) {
          this.opened = false;
        }
      },

      _trackHandler: function(event) {
        if (!this.persistent) {
          switch (event.detail.state) {
            case 'start':
              this.$.drawerContent.style.transitionDuration = '0s';
              this.$.drawerContent.style.webkitTransitionDuration = '0s';

              if (this.opened) {
                this._translateOffset = 0;
              } else if (this.position == 'left') {
                this._translateOffset = -this.getDrawerWidth();
              } else if (this.position == 'right') {
                this._translateOffset = this.getDrawerWidth();
              }
              break;

            case 'track':
              switch (this.position) {
                case 'left':
                  this._translateDrawer(Math.min(0, event.detail.dx + this._translateOffset));
                  break;
                case 'right':
                  this._translateDrawer(Math.max(0, event.detail.dx + this._translateOffset));
                  break;
              }
              if (Math.abs(event.detail.ddx) > 0) {
                this._lastTrackDirection = event.detail.ddx;
              }
              break;

            case 'end':
              this.$.drawerContent.style.transitionDuration = '';
              this.$.drawerContent.style.webkitTransitionDuration = '';
              this.transform('', this.$.drawerContent);
              this.opened = (this.position === 'left' && this._lastTrackDirection > 0) ||
                (this.position === 'right' && this._lastTrackDirection < 0);
              break;
          }
        }
      },

      _openedChanged: function() {
        this._updateDocScroll();
      },

      _persistentChanged: function() {
        this._updateDocScroll();
      },

      _translateDrawer: function(x) {
        this.transform('translateX(' + x + 'px)', this.$.drawerContent);
      },

      _updateDocScroll: function() {
        this.shouldEnableDocScroll(this.persistent || !this.opened);
      },

      _isScrimVisible: function(opened, persistent) {
        return opened && !persistent;
      }

    });

  </script>

</dom-module>
